```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Merry Christmas, Pearl</title>
    <link href="[https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap](https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap)" rel="stylesheet">
    
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Arial', sans-serif; user-select: none; -webkit-user-select: none; -webkit-tap-highlight-color: transparent; }
        canvas { display: block; }
        
        #title { position: absolute; top: 25px; width: 100%; text-align: center; color: #fffae3; font-size: 55px; font-family: 'Great Vibes', cursive; text-shadow: 0 0 10px #ffd700, 0 0 20px #ff8c00, 0 0 30px #ff0000; z-index: 998; pointer-events: none; animation: glow 3s ease-in-out infinite alternate; }
        #greeting { position: absolute; top: 90px; width: 100%; text-align: center; color: #f0f0f0; font-size: 14px; font-style: italic; text-shadow: 0 0 5px rgba(255,255,255,0.2); z-index: 997; pointer-events: none; }
        @keyframes glow { from { text-shadow: 0 0 10px #ffd700, 0 0 20px #ff8c00; opacity: 0.9; } to { text-shadow: 0 0 20px #ffd700, 0 0 30px #ff8c00, 0 0 40px #ff0000; opacity: 1; } }
        
        .btn-group { position: absolute; top: 140px; right: 20px; display: flex; flex-direction: column; gap: 12px; z-index: 999; align-items: flex-end; }
        .action-btn { padding: 10px 18px; border-radius: 50px; font-size: 14px; cursor: pointer; color: rgba(255, 255, 255, 0.95); transition: all 0.3s ease; white-space: nowrap; }
        .glass-btn { background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.3); backdrop-filter: blur(8px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .action-btn:active { transform: scale(0.95); background: rgba(255, 255, 255, 0.25); }
        #clearBtn { background: rgba(255, 50, 50, 0.2); border: 1px solid rgba(255, 100, 100, 0.3); }
        
        /* 隐私提示 */
        .privacy-hint { font-size: 10px; color: rgba(255,255,255,0.6); margin-top: 4px; text-align: right; font-family: sans-serif; pointer-events: none; text-shadow: 0 0 2px #000; }
        
        #tip { position: absolute; bottom: 30px; width: 100%; text-align: center; color: rgba(255,255,255,0.7); font-size: 14px; pointer-events: none; text-shadow: 0 0 5px rgba(0,0,0,0.8); animation: fadeTip 2s infinite ease-in-out; }
        @keyframes fadeTip { 0%, 100% { opacity: 0.4; } 50% { opacity: 1; } }
    </style>
</head>
<body>
    <div id="title">Merry Christmas</div>
    <div id="greeting">Wishing you a season of joy & smooth sailing. Made by Pearl.</div> 
    
    <input type="file" id="fileInput" accept="image/*" multiple style="display: none;">
    
    <div class="btn-group">
        <div id="musicBtn" class="action-btn glass-btn">Play Music</div>
        <div id="clearBtn" class="action-btn glass-btn">Clear Photos</div>
        <div id="uploadBtn" class="action-btn glass-btn" onclick="document.getElementById('fileInput').click()">Upload Photos</div>
        <div class="privacy-hint">*Privacy Safe: Photos stay on your device.</div>
    </div>
    
    <div id="tip">Double Tap to Explore</div>

    <script src="[https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js](https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js)"></script>
    <script src="[https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js](https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js)"></script>
    
    <script>
        const scene = new THREE.Scene();
        // 雾气改回原来的黑色，保证流畅
        scene.fog = new THREE.FogExp2(0x000000, 0.012);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 2, 14);

        const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.body.appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 4.0;

        let christmasGroup = new THREE.Group();
        scene.add(christmasGroup);
        let isExploded = false;

        // 音乐 (Catbox M4A)
        const musicBtn = document.getElementById('musicBtn');
        let isMusicPlaying = false;
        const sound = new Audio('[https://files.catbox.moe/0talca.m4a](https://files.catbox.moe/0talca.m4a)');
        sound.loop = true;
        sound.volume = 1.0;
        document.body.addEventListener('touchstart', () => sound.load(), {once:true});
        
        musicBtn.onclick = e => {
            e.stopPropagation();
            if (isMusicPlaying) {
                sound.pause();
                musicBtn.innerText = "Play Music";
                musicBtn.style.background = "rgba(255, 255, 255, 0.15)";
            } else {
                sound.play().then(() => {
                    musicBtn.innerText = "Pause Music";
                    musicBtn.style.background = "rgba(50, 255, 50, 0.2)";
                });
            }
            isMusicPlaying = !isMusicPlaying;
        };

        // 烟花
        const fireTex = (() => {
            const c = document.createElement('canvas'); c.width = c.height = 32;
            const ctx = c.getContext('2d');
            const g = ctx.createRadialGradient(16, 16, 0, 16, 16, 16);
            g.addColorStop(0, '#fff'); g.addColorStop(1, 'transparent');
            ctx.fillStyle = g; ctx.fillRect(0, 0, 32, 32);
            return new THREE.CanvasTexture(c);
        })();
        let fireworks = [];
        class Firework {
            constructor(s) {
                this.scene = s; this.isDead = false; this.life = 1.0;
                const count = 40; // 降低数量保流畅
                const geo = new THREE.BufferGeometry(); const p = []; const v = [];
                const col = new THREE.Color().setHSL(Math.random() * 0.3, 1, 0.7);
                const x = (Math.random() - 0.5) * 20, y = 5 + Math.random() * 10, z = -10;
                for (let i = 0; i < count; i++) {
                    p.push(x, y, z);
                    const t = Math.random() * Math.PI * 2, h = Math.random() * Math.PI, s = 0.1 + Math.random() * 0.2;
                    v.push(Math.sin(h) * Math.cos(t) * s, Math.sin(h) * Math.sin(t) * s, Math.cos(h) * s);
                }
                geo.setAttribute('position', new THREE.Float32BufferAttribute(p, 3));
                this.mesh = new THREE.Points(geo, new THREE.PointsMaterial({ size: 0.8, color: col, map: fireTex, transparent: true, blending: THREE.AdditiveBlending, depthWrite: false }));
                this.vel = v; s.add(this.mesh);
            }
            update() {
                if (this.isDead) return;
                const pos = this.mesh.geometry.attributes.position.array;
                for (let i = 0; i < this.vel.length / 3; i++) {
                    pos[i * 3] += this.vel[i * 3]; pos[i * 3 + 1] += this.vel[i * 3 + 1]; pos[i * 3 + 2] += this.vel[i * 3 + 2];
                    this.vel[i * 3 + 1] -= 0.003;
                }
                this.mesh.geometry.attributes.position.needsUpdate = true;
                this.life -= 0.02; this.mesh.material.opacity = this.life;
                if (this.life <= 0) { this.isDead = true; this.scene.remove(this.mesh); this.mesh.geometry.dispose(); }
            }
        }

        // 双击交互
        let lastTapTime = 0;
        renderer.domElement.addEventListener('touchend', e => {
            const now = Date.now();
            if (now - lastTapTime < 300) { toggleExplosion(); e.preventDefault(); }
            lastTapTime = now;
        });
        window.addEventListener('dblclick', e => { if (!e.target.closest('.action-btn')) toggleExplosion(); });

        function toggleExplosion() {
            isExploded = !isExploded;
            controls.autoRotate = !isExploded;
            if (isExploded) for (let i = 0; i < 4; i++) setTimeout(() => fireworks.push(new Firework(scene)), i * 300);
        }

        // 星空 (控制数量在 1000，保证极度流畅)
        function createStars() {
            const geo = new THREE.BufferGeometry(); const p = [];
            for (let i = 0; i < 1000; i++) p.push((Math.random() - 0.5) * 200, (Math.random() - 0.5) * 200, (Math.random() - 0.5) * 200);
            geo.setAttribute('position', new THREE.Float32BufferAttribute(p, 3));
            const stars = new THREE.Points(geo, new THREE.PointsMaterial({ size: 0.2, color: 0xffffff, transparent: true, opacity: 0.8 }));
            scene.add(stars);
        }
        createStars();

        // 圣诞树 (昨晚的经典逻辑)
        function getTreePosition(h = 12, r = 6) {
            const y = Math.random() * h - h / 2;
            const n = (y + h / 2) / h;
            const rad = r * (1 - n) * Math.sqrt(Math.random());
            const a = Math.random() * Math.PI * 2;
            return { x: Math.cos(a) * rad, y, z: Math.sin(a) * rad };
        }
        // 【优化】树叶数量降至 800
        function createLeaves() {
            const geo = new THREE.BufferGeometry(); const p = []; const c = []; const col = new THREE.Color();
            for (let i = 0; i < 800; i++) {
                const pos = getTreePosition(13, 6.5); p.push(pos.x, pos.y, pos.z);
                const r = Math.random();
                // 经典绿色
                if (r > 0.8) col.setHex(0x226622); else if (r > 0.4) col.setHex(0x115511); else col.setHex(0x004400);
                c.push(col.r, col.g, col.b);
            }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(p, 3));
            geo.setAttribute('color', new THREE.Float32BufferAttribute(c, 3));
            christmasGroup.add(new THREE.Points(geo, new THREE.PointsMaterial({ size: 0.6, vertexColors: true, transparent: true, opacity: 0.8, blending: THREE.AdditiveBlending })));
        }
        createLeaves();

        // 顶星
        function createTopStar() {
            const geo = new THREE.ConeGeometry(0.8, 0.8, 4); 
            const mat = new THREE.MeshStandardMaterial({ color: 0xffd700, emissive: 0xffaa00, emissiveIntensity: 0.5 });
            const star = new THREE.Mesh(geo, mat); star.position.y = 6.5; 
            star.userData = { type: 'star' }; christmasGroup.add(star);
            scene.add(new THREE.PointLight(0xffaa00, 1, 8).translateY(6.5));
        }
        createTopStar();

        // 【优化】彩灯数量降至 200
        function addDecorLights() {
            const geo = new THREE.BufferGeometry(); const p = []; const c = []; const col = new THREE.Color();
            const cs = [0xff0000, 0xffff00, 0x00ffff, 0xff00ff, 0xffaa00];
            for (let i = 0; i < 200; i++) {
                const pos = getTreePosition(12.5, 6.2); p.push(pos.x * 1.05, pos.y, pos.z * 1.05);
                col.setHex(cs[~~(Math.random() * cs.length)]); c.push(col.r, col.g, col.b);
            }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(p, 3));
            geo.setAttribute('color', new THREE.Float32BufferAttribute(c, 3));
            const m = new THREE.PointsMaterial({ size: 0.8, map: fireTex, vertexColors: true, blending: THREE.AdditiveBlending, depthWrite: false });
            christmasGroup.add(new THREE.Points(geo, m)).userData = { type: 'lights' };
        }
        addDecorLights();

        // 照片逻辑 (球形分布 + 梦幻光晕 + 散开变大)
        const glowTex = (() => {
            const c = document.createElement('canvas'); c.width = c.height = 64;
            const ctx = c.getContext('2d');
            const g = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);
            g.addColorStop(0, 'rgba(255,255,220,0.3)'); g.addColorStop(1, 'transparent');
            ctx.fillStyle = g; ctx.fillRect(0, 0, 64, 64); return new THREE.CanvasTexture(c);
        })();
        const glowMat = new THREE.SpriteMaterial({ map: glowTex, transparent: true, blending: THREE.AdditiveBlending, depthWrite: false });
        function createPolaroidTexture(img) {
            const c = document.createElement('canvas'); c.width = 256; c.height = 300;
            const ctx = c.getContext('2d'); ctx.fillStyle = '#fffdf5'; ctx.fillRect(0, 0, 256, 300);
            const b = 15, s = 256 - b * 2; const sc = Math.max(s / img.width, s / img.height);
            const px = (s / 2) - (img.width / 2) * sc, py = (s / 2) - (img.height / 2) * sc;
            ctx.save(); ctx.beginPath(); ctx.rect(b, b, s, s); ctx.clip();
            ctx.drawImage(img, b + px, b + py, img.width * sc, img.height * sc);
            ctx.restore(); ctx.strokeStyle = '#eee'; ctx.lineWidth = 2; ctx.strokeRect(0, 0, 256, 300);
            return new THREE.CanvasTexture(c);
        }
        const cardGeo = new THREE.PlaneGeometry(1.2, 1.4);

        document.getElementById('fileInput').onchange = e => {
            const files = [...e.target.files].slice(0, 25);
            files.forEach(f => {
                const r = new FileReader();
                r.onload = ev => {
                    const img = new Image(); img.src = ev.target.result;
                    img.onload = () => {
                        const tex = createPolaroidTexture(img);
                        const mat = new THREE.MeshStandardMaterial({ map: tex, side: THREE.DoubleSide, roughness: .8, metalness: .1, emissive: 0xffffff, emissiveIntensity: .1 });
                        const card = new THREE.Mesh(cardGeo, mat);
                        const p = getTreePosition(12, 6); card.position.set(p.x * 1.3, p.y, p.z * 1.3);
                        card.lookAt(0, p.y, 0); card.rotation.z += (Math.random() - .5) * .3; card.rotation.x += .1;
                        const glow = new THREE.Sprite(glowMat); glow.scale.set(3, 3, 1); glow.position.z = -.1; card.add(glow);
                        card.userData = {
                            type: 'photo', originPos: card.position.clone(), originRot: card.rotation.clone(),
                            // 球形分布目标
                            targetPos: new THREE.Vector3((Math.random() - .5) * 14, (Math.random() - .5) * 12, 5 + Math.random() * 4),
                            randomPhase: Math.random() * Math.PI * 2
                        };
                        christmasGroup.add(card);
                    }
                };
                r.readAsDataURL(f);
            });
            document.getElementById('fileInput').value = '';
        };

        document.getElementById('clearBtn').onclick = e => {
            e.stopPropagation();
            for (let i = christmasGroup.children.length - 1; i >= 0; i--)
                if (christmasGroup.children[i].userData?.type === 'photo') christmasGroup.remove(christmasGroup.children[i]);
        };

        scene.add(new THREE.AmbientLight(0xffffff, .6)); scene.add(new THREE.DirectionalLight(0xffffff, 1));

        (function animate() {
            requestAnimationFrame(animate); controls.update();
            fireworks.forEach((f, i) => { f.update(); if (f.isDead) fireworks.splice(i, 1); });
            const t = Date.now() * .001; const ls = .05;
            if (isExploded) christmasGroup.rotation.y += .001;
            
            christmasGroup.children.forEach(o => {
                if (o.userData?.type === 'photo') {
                    if (isExploded) {
                        o.position.lerp(o.userData.targetPos, ls); o.scale.lerp(new THREE.Vector3(1.8, 1.8, 1.8), ls);
                        o.position.y += Math.sin(t + o.userData.randomPhase) * .005; o.lookAt(camera.position);
                        if (o.children[0]) o.children[0].scale.lerp(new THREE.Vector3(4, 4, 1), ls);
                    } else {
                        o.position.lerp(o.userData.originPos, ls); o.scale.lerp(new THREE.Vector3(1, 1, 1), ls);
                        if (o.position.distanceTo(o.userData.originPos) < 1) o.rotation.lerp(o.userData.originRot, .1);
                        else o.lookAt(0, o.position.y, 0);
                        if (o.children[0]) o.children[0].scale.lerp(new THREE.Vector3(3, 3, 1), ls);
                    }
                }
                if (o.userData?.type === 'leaves') {
                    // 树叶变大变淡
                    o.scale.lerp(new THREE.Vector3(isExploded ? 3.5 : 1, isExploded ? 3.5 : 1, isExploded ? 3.5 : 1), .05);
                    o.material.opacity = THREE.MathUtils.lerp(o.material.opacity, isExploded ? .2 : .8, .05);
                    if (isExploded) o.rotation.y += .002;
                }
                if (o.userData?.type === 'lights') {
                    o.scale.lerp(new THREE.Vector3(isExploded ? 2 : 1, isExploded ? 2 : 1, isExploded ? 2 : 1), .05);
                    o.material.opacity = THREE.MathUtils.lerp(o.material.opacity, isExploded ? 1 : .8, .05);
                    if (isExploded) o.rotation.y += .002;
                }
                if (o.userData?.type === 'star') {
                    const s = isExploded ? 0.001 : 1;
                    o.scale.lerp(new THREE.Vector3(s, s, s), .05);
                    o.rotation.y += .01;
                }
            });
            renderer.render(scene, camera);
        })();
        window.onresize = () => { camera.aspect = innerWidth / innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth, innerHeight); };
    </script>
</body>
</html>