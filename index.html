<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Merry Christmas, Pearl</title>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
    
    <style>
        /* CSS Ê†∑ÂºèÈÉ®ÂàÜ */
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Arial', sans-serif;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        canvas { display: block; }

        /* ‰∏ªÊ†áÈ¢ò */
        #title {
            position: absolute; top: 25px; width: 100%; text-align: center;
            color: #fffae3; font-size: 55px; font-family: 'Great Vibes', cursive;
            text-shadow: 0 0 10px #ffd700, 0 0 20px #ff8c00, 0 0 30px #ff0000;
            z-index: 998; pointer-events: none;
            animation: glow 3s ease-in-out infinite alternate;
        }

        /* ÊÇ®ÁöÑÁ•ùÁ¶èËØ≠ÂíåÁΩ≤Âêç */
        #greeting {
            position: absolute; top: 90px; width: 100%; text-align: center;
            color: #f0f0f0; font-size: 14px; font-style: italic;
            text-shadow: 0 0 5px rgba(255,255,255,0.2);
            z-index: 997; pointer-events: none;
        }
        
        @keyframes glow {
            from { text-shadow: 0 0 10px #ffd700, 0 0 20px #ff8c00; opacity: 0.9; }
            to { text-shadow: 0 0 20px #ffd700, 0 0 30px #ff8c00, 0 0 40px #ff0000; opacity: 1; }
        }

        /* ÊåâÈíÆÁªÑ */
        .btn-group {
            position: absolute; top: 140px; right: 20px; /* Ë∞ÉÊï¥‰ΩçÁΩÆÈÅøÂºÄÁ•ùÁ¶èËØ≠ */
            display: flex; flex-direction: column; gap: 15px;
            z-index: 999; align-items: flex-end;
        }

        .action-btn {
            padding: 10px 18px; border-radius: 50px; font-size: 14px;
            cursor: pointer; color: rgba(255, 255, 255, 0.95);
            transition: all 0.3s ease; white-space: nowrap;
        }

        .glass-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .action-btn:active { transform: scale(0.95); background: rgba(255, 255, 255, 0.25); }

        #clearBtn { background: rgba(255, 50, 50, 0.2); border: 1px solid rgba(255, 100, 100, 0.3); }

        /* Â∫ïÈÉ®ÊèêÁ§∫ */
        #tip {
            position: absolute; bottom: 30px; width: 100%; text-align: center;
            color: rgba(255,255,255,0.7); font-size: 14px; pointer-events: none;
            text-shadow: 0 0 5px rgba(0,0,0,0.8);
            animation: fadeTip 2s infinite ease-in-out;
        }
        @keyframes fadeTip { 0%, 100% { opacity: 0.4; } 50% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="title">Merry Christmas</div>
    <div id="greeting">Wishing you a season of joy & smooth sailing. Made by Pearl.</div> 

    <input type="file" id="fileInput" accept="image/*" multiple style="display: none;">
    
    <div class="btn-group">
        <div id="musicBtn" class="action-btn glass-btn">üéµ Play Music</div>
        <div id="clearBtn" class="action-btn glass-btn">üóëÔ∏è Clear Photos</div>
        <div id="uploadBtn" class="action-btn glass-btn" onclick="document.getElementById('fileInput').click()">üì∑ Upload Photos</div>
    </div>
    
    <div id="tip">‚ú® Double Tap to Explore ‚ú®</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        // 1. ÂàùÂßãÂåñÂú∫ÊôØ
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.012); 

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 2, 14);

        const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); 
        document.body.appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 4.0;

        let christmasGroup = new THREE.Group();
        scene.add(christmasGroup);

        let isExploded = false;

        // =========================================
        // 2. Èü≥‰πêÊéßÂà∂ (ÊúÄÁªàÈîÅÂÆöÊÇ®ÁöÑ M4A ÈìæÊé•)
        // =========================================
        const musicBtn = document.getElementById('musicBtn');
        let isMusicPlaying = false;
        let sound = new Audio();

        // ÊÇ®ÁöÑ Catbox M4A Áõ¥Èìæ (ÊúÄ‰ºòÂÖºÂÆπÊ†ºÂºè)
        sound.src = 'https://files.catbox.moe/0talca.m4a';

        sound.loop = true;
        sound.volume = 1.0;
        sound.crossOrigin = "anonymous"; 

        // Ëß¶Êë∏Ëß£ÈîÅÈÄªËæë
        document.body.addEventListener('touchstart', function() {
            if(sound.paused) { sound.load(); }
        }, {once:true});

        musicBtn.addEventListener('click', (e) => {
            e.stopPropagation(); 
            if (isMusicPlaying) {
                sound.pause();
                musicBtn.innerText = "üéµ Play Music"; // Ëã±Êñá
                musicBtn.style.background = "rgba(255, 255, 255, 0.15)";
            } else {
                const p = sound.play();
                if (p !== undefined) {
                    p.then(_ => {
                        musicBtn.innerText = "‚è∏ Pause Music"; // Ëã±Êñá
                        musicBtn.style.background = "rgba(50, 255, 50, 0.2)";
                    }).catch(error => {
                        alert("Playback Failed. Please ensure Mute Switch is OFF."); // Ëã±ÊñáÊèêÁ§∫
                        isMusicPlaying = false;
                    });
                }
            }
            isMusicPlaying = !isMusicPlaying;
        });

        // =========================================
        // 3. ‰∫§‰∫í‰∏éÁÉüËä±
        // =========================================
        function createFireworkTexture() {
            const c = document.createElement('canvas'); c.width=32; c.height=32;
            const ctx = c.getContext('2d');
            const g = ctx.createRadialGradient(16,16,0,16,16,16);
            g.addColorStop(0, 'rgba(255,255,255,1)'); g.addColorStop(1, 'rgba(255,255,255,0)');
            ctx.fillStyle = g; ctx.fillRect(0,0,32,32);
            return new THREE.CanvasTexture(c);
        }
        const fireTex = createFireworkTexture();
        let fireworks = [];

        class Firework {
            constructor(scene) {
                this.scene = scene; this.isDead = false; this.life = 1.0;
                const count = 50; 
                const geo = new THREE.BufferGeometry();
                const pos = []; const vel = [];
                const color = new THREE.Color().setHSL(Math.random(), 1, 0.6);
                const cx = (Math.random()-0.5)*20; const cy = 5+Math.random()*10; const cz = -10;
                for(let i=0; i<count; i++) {
                    pos.push(cx, cy, cz);
                    const theta = Math.random()*Math.PI*2; const phi = Math.random()*Math.PI;
                    const spd = 0.1+Math.random()*0.2;
                    vel.push(Math.sin(phi)*Math.cos(theta)*spd, Math.sin(phi)*Math.sin(theta)*spd, Math.cos(phi)*spd);
                }
                geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
                this.mesh = new THREE.Points(geo, new THREE.PointsMaterial({size:0.8, color:color, map:fireTex, transparent:true, blending:THREE.AdditiveBlending, depthWrite:false}));
                this.vel = vel;
                scene.add(this.mesh);
            }
            update() {
                if(this.isDead) return;
                const pos = this.mesh.geometry.attributes.position.array;
                for(let i=0; i<this.vel.length/3; i++) {
                    pos[i*3] += this.vel[i*3]; pos[i*3+1] += this.vel[i*3+1]; pos[i*3+2] += this.vel[i*3+2];
                    this.vel[i*3+1] -= 0.003; 
                }
                this.mesh.geometry.attributes.position.needsUpdate = true;
                this.life -= 0.02; 
                this.mesh.material.opacity = this.life;
                if(this.life<=0) { this.isDead=true; this.scene.remove(this.mesh); this.mesh.geometry.dispose(); }
            }
        }

        let lastTapTime = 0;
        renderer.domElement.addEventListener('touchend', (e) => {
            const currentTime = new Date().getTime();
            if (currentTime - lastTapTime < 300) { toggleExplosion(); e.preventDefault(); }
            lastTapTime = currentTime;
        });
        window.addEventListener('dblclick', (e) => { if(!e.target.closest('.action-btn')) toggleExplosion(); });

        function toggleExplosion() {
            isExploded = !isExploded;
            controls.autoRotate = !isExploded;
            if(isExploded) {
                for(let i=0; i<4; i++) setTimeout(()=>fireworks.push(new Firework(scene)), i*300);
            }
        }

        // =========================================
        // 4. ËÉåÊôØÔºöÈ´òÂØÜÂ∫¶Èì∂Ê≤≥ÊòüÁ©∫ & ÊµÅÊòü
        // =========================================
        function createMeteorTexture() {
            const c = document.createElement('canvas'); c.width=32; c.height=32;
            const ctx = c.getContext('2d');
            const g = ctx.createLinearGradient(0,0,32,0);
            g.addColorStop(0,'rgba(255,255,255,0)'); g.addColorStop(1,'white');
            ctx.fillStyle=g; ctx.fillRect(0,0,32,32);
            return new THREE.CanvasTexture(c);
        }
        const meteorTex = createMeteorTexture();
        let meteors = [];
        function updateMeteors() {
            if(Math.random() > 0.96 && meteors.length < 5) { 
                const m = new THREE.Mesh(new THREE.PlaneGeometry(2, 0.1), new THREE.MeshBasicMaterial({map:meteorTex, transparent:true, opacity:0.6, side:THREE.DoubleSide, blending:THREE.AdditiveBlending}));
                m.position.set(20+Math.random()*20, 20+Math.random()*20, -20);
                m.rotation.z = Math.PI/4;
                scene.add(m);
                meteors.push({mesh:m, speed:0.3+Math.random()*0.3});
            }
            for(let i=meteors.length-1; i>=0; i--) {
                const item = meteors[i];
                item.mesh.position.x -= item.speed; item.mesh.position.y -= item.speed*0.7;
                if(item.mesh.position.x < -30) { scene.remove(item.mesh); meteors.splice(i,1); }
            }
        }

        // 8000È¢óÈì∂Ê≤≥ÊòüÊòü
        function createGalaxyStars() {
            const geo = new THREE.BufferGeometry(); const pos = []; const colors = []; const colorObj = new THREE.Color();
            for(let i=0; i<8000; i++) {
                pos.push((Math.random()-0.5)*350, (Math.random()-0.5)*350, (Math.random()-0.5)*350);
                const r = Math.random();
                if(r>0.9) colorObj.setHex(0xaaccff); else if(r>0.8) colorObj.setHex(0xffddaa); else colorObj.setHex(0xffffff);
                colors.push(colorObj.r, colorObj.g, colorObj.b);
            }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            geo.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            
            const stars = new THREE.Points(geo, new THREE.PointsMaterial({size:0.3, vertexColors:true, transparent:true, opacity:1.0, sizeAttenuation:true}));
            stars.userData = { type: 'bgStars' };
            scene.add(stars);
        }
        createGalaxyStars();

        // =========================================
        // 5. Âú£ËØûÊ†ë
        // =========================================
        function getTreePosition(height = 12, radiusBase = 6.0) {
            const y = Math.random() * height - height / 2;
            const normY = (y + height / 2) / height;
            const r = radiusBase * (1 - normY);
            const angle = Math.random() * Math.PI * 2;
            const rad = r * Math.sqrt(Math.random()); 
            return { x: Math.cos(angle)*rad, y: y, z: Math.sin(angle)*rad };
        }

        function createLeaves() {
            const geo = new THREE.BufferGeometry(); const pos = []; const col = []; const cObj = new THREE.Color();
            for(let i=0; i<1600; i++) {
                const p = getTreePosition(13, 6.5); pos.push(p.x, p.y, p.z);
                const r = Math.random();
                if (r>0.8) cObj.setHex(0x226622); else if (r>0.4) cObj.setHex(0x115511); else cObj.setHex(0x004400);
                col.push(cObj.r, cObj.g, cObj.b);
            }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            geo.setAttribute('color', new THREE.Float32BufferAttribute(col, 3));
            const leaves = new THREE.Points(geo, new THREE.PointsMaterial({size:0.5, vertexColors:true, transparent:true, opacity:0.8, blending: THREE.AdditiveBlending}));
            leaves.userData = { type: 'leaves' };
            christmasGroup.add(leaves);
        }
        createLeaves();

        function createTopStar() {
            const shape = new THREE.Shape();
            const points = 5; const outer = 0.8; const inner = 0.4;
            for (let i = 0; i < points * 2; i++) {
                const angle = (i * Math.PI) / points;
                const r = i % 2 === 0 ? outer : inner;
                const x = Math.cos(angle) * r; const y = Math.sin(angle) * r;
                if (i === 0) shape.moveTo(x, y); else shape.lineTo(x, y);
            }
            shape.closePath();
            const geo = new THREE.ExtrudeGeometry(shape, { depth: 0.3, bevelEnabled: true, bevelThickness:0.1, bevelSize:0.05, bevelSegments:2 });
            const mat = new THREE.MeshStandardMaterial({ color: 0xffd700, emissive: 0xffaa00, emissiveIntensity: 0.4, roughness: 0.2, metalness: 0.9 });
            const star = new THREE.Mesh(geo, mat);
            star.position.set(0, 6.5, 0);
            star.userData = { type: 'star' }; 
            christmasGroup.add(star);
            scene.add(new THREE.PointLight(0xffaa00, 1, 8).translateY(6.5));
        }
        createTopStar();

        function addDecorLights() {
            const geo = new THREE.BufferGeometry(); const pos = []; const col = []; const cObj = new THREE.Color();
            const colors = [0xff0000, 0xffff00, 0x00ffff, 0xff00ff, 0xffaa00];
            for(let i=0; i<450; i++) {
                const p = getTreePosition(12.5, 6.2); const s = 1.05; 
                pos.push(p.x*s, p.y, p.z*s);
                cObj.setHex(colors[Math.floor(Math.random()*colors.length)]); col.push(cObj.r, cObj.g, cObj.b);
            }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            geo.setAttribute('color', new THREE.Float32BufferAttribute(col, 3));
            const mat = new THREE.PointsMaterial({size:0.8, color:0xffffff, map:createFireworkTexture(), vertexColors:true, blending:THREE.AdditiveBlending, depthWrite:false});
            const pts = new THREE.Points(geo, mat);
            pts.userData = { type: 'lights' };
            christmasGroup.add(pts);
        }
        addDecorLights();

        // =========================================
        // 6. ÁÖßÁâáÈÄªËæë
        // =========================================
        function createGlowTexture() {
            const c = document.createElement('canvas'); c.width=64; c.height=64;
            const ctx = c.getContext('2d');
            const g = ctx.createRadialGradient(32,32,0,32,32,32);
            g.addColorStop(0, 'rgba(255,255,220,0.3)'); g.addColorStop(1, 'rgba(0,0,0,0)');
            ctx.fillStyle = g; ctx.fillRect(0,0,64,64);
            return new THREE.CanvasTexture(c);
        }
        const glowTex = createGlowTexture();
        const glowMat = new THREE.SpriteMaterial({ map: glowTex, transparent: true, blending: THREE.AdditiveBlending, depthWrite: false });

        function createPolaroidTexture(img) {
            const c = document.createElement('canvas'); c.width=256; c.height=300; 
            const ctx = c.getContext('2d');
            ctx.fillStyle = '#fffdf5'; ctx.fillRect(0, 0, 256, 300);
            const b = 15; const s = 256 - b*2;
            const sc = Math.max(s/img.width, s/img.height);
            const px = (s/2)-(img.width/2)*sc; const py = (s/2)-(img.height/2)*sc;
            ctx.save(); ctx.beginPath(); ctx.rect(b, b, s, s); ctx.clip();
            ctx.drawImage(img, b+px, b+py, img.width*sc, img.height*sc);
            ctx.restore();
            ctx.strokeStyle='#eee'; ctx.lineWidth=2; ctx.strokeRect(0,0,256,300);
            const t = new THREE.CanvasTexture(c); t.minFilter = THREE.LinearFilter;
            return t;
        }
        const cardGeo = new THREE.PlaneGeometry(1.2, 1.4);

        const fileInput = document.getElementById('fileInput');
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files).slice(0, 25);
            if (files.length === 0) return;
            files.forEach((file) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image(); img.src = event.target.result;
                    img.onload = () => {
                        const tex = createPolaroidTexture(img);
                        const cardMat = new THREE.MeshStandardMaterial({ map: tex, side: THREE.DoubleSide, roughness: 0.8, metalness: 0.1, emissive: 0xffffff, emissiveIntensity: 0.1 });
                        const card = new THREE.Mesh(cardGeo, cardMat);
                        
                        const p = getTreePosition(12, 6);
                        card.position.set(p.x*1.3, p.y, p.z*1.3);
                        card.lookAt(0, p.y, 0); card.rotation.z += (Math.random()-0.5)*0.3; card.rotation.x += 0.1;

                        const glow = new THREE.Sprite(glowMat);
                        glow.scale.set(3, 3, 1); glow.position.z = -0.1; card.add(glow);

                        const tx = (Math.random()-0.5)*14; 
                        const ty = (Math.random()-0.5)*12; 
                        const tz = 5+Math.random()*4;

                        card.userData = {
                            type: 'photo',
                            originPos: card.position.clone(),
                            originRot: card.rotation.clone(),
                            targetPos: new THREE.Vector3(tx, ty, tz),
                            randomPhase: Math.random() * Math.PI * 2,
                        };
                        christmasGroup.add(card);
                    };
                };
                reader.readAsDataURL(file);
            });
            fileInput.value = ''; 
        });

        document.getElementById('clearBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            for(let i=christmasGroup.children.length-1; i>=0; i--) {
                if(christmasGroup.children[i].userData.type === 'photo') christmasGroup.remove(christmasGroup.children[i]);
            }
        });

        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        scene.add(new THREE.DirectionalLight(0xffffff, 1.0));

        // =========================================
        // 7. Âä®ÁîªÂæ™ÁéØ
        // =========================================
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            updateMeteors();
            
            for(let i=fireworks.length-1; i>=0; i--) {
                fireworks[i].update();
                if(fireworks[i].isDead) fireworks.splice(i, 1);
            }

            const time = Date.now() * 0.001;
            const lerpSpeed = 0.05;

            if(isExploded) christmasGroup.rotation.y += 0.001;

            const bgStars = scene.children.find(c => c.userData.type === 'bgStars');
            if(bgStars) {
                bgStars.rotation.y -= 0.0003;
                bgStars.material.opacity = 0.85 + Math.sin(time*1.5)*0.15; 
            }

            christmasGroup.children.forEach(obj => {
                if (obj.userData.type === 'photo') {
                    if (isExploded) {
                        obj.position.lerp(obj.userData.targetPos, lerpSpeed);
                        obj.scale.lerp(new THREE.Vector3(1.8, 1.8, 1.8), lerpSpeed); 
                        obj.position.y += Math.sin(time + obj.userData.randomPhase) * 0.005; 
                        obj.lookAt(camera.position); 
                        if(obj.children[0]) obj.children[0].scale.lerp(new THREE.Vector3(4, 4, 1), lerpSpeed);
                    } else {
                        obj.position.lerp(obj.userData.originPos, lerpSpeed);
                        obj.scale.lerp(new THREE.Vector3(1, 1, 1), lerpSpeed);
                        if (obj.position.distanceTo(obj.userData.originPos) < 1.0) {
                            obj.rotation.x = THREE.MathUtils.lerp(obj.rotation.x, obj.userData.originRot.x, 0.1);
                            obj.rotation.y = THREE.MathUtils.lerp(obj.rotation.y, obj.userData.originRot.y, 0.1);
                            obj.rotation.z = THREE.MathUtils.lerp(obj.rotation.z, obj.userData.originRot.z, 0.1);
                        } else {
                            obj.lookAt(0, obj.position.y, 0); 
                        }
                        if(obj.children[0]) obj.children[0].scale.lerp(new THREE.Vector3(3, 3, 1), lerpSpeed);
                    }
                }
                
                if (obj.userData.type === 'leaves') {
                    if (isExploded) {
                        obj.scale.lerp(new THREE.Vector3(3.5, 3.5, 3.5), lerpSpeed);
                        if(obj.material) obj.material.opacity = THREE.MathUtils.lerp(obj.material.opacity, 0.2, lerpSpeed);
                        obj.rotation.y += 0.002;
                    } else {
                        obj.scale.lerp(new THREE.Vector3(1, 1, 1), lerpSpeed);
                        if(obj.material) obj.material.opacity = THREE.MathUtils.lerp(obj.material.opacity, 0.8, lerpSpeed);
                        obj.rotation.y = 0;
                    }
                }
                if (obj.userData.type === 'lights') {
                    if (isExploded) {
                        obj.scale.lerp(new THREE.Vector3(2.0, 2.0, 2.0), lerpSpeed);
                        if(obj.material) obj.material.opacity = THREE.MathUtils.lerp(obj.material.opacity, 1.0, lerpSpeed);
                        obj.rotation.y += 0.002;
                    } else {
                        obj.scale.lerp(new THREE.Vector3(1, 1, 1), lerpSpeed);
                        if(obj.material) obj.material.opacity = THREE.MathUtils.lerp(obj.material.opacity, 0.8, lerpSpeed);
                        obj.rotation.y = 0;
                    }
                }

                if (obj.userData.type === 'star' || obj.userData.type === 'starLight') {
                    const targetScale = isExploded ? 0.001 : 1.0;
                    obj.scale.lerp(new THREE.Vector3(targetScale, targetScale, targetScale), lerpSpeed);
                }
                if (obj.userData.type === 'star') {
                    obj.rotation.y += 0.01;
                }
            });

            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
