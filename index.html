<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Dreamy Christmas</title>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
    <style>
        body{margin:0;overflow:hidden;background:#000;font-family:Arial,sans-serif;user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent}
        canvas{display:block}
        #title{position:absolute;top:30px;width:100%;text-align:center;color:#fff;font-size:50px;font-family:'Great Vibes',cursive;text-shadow:0 0 10px #fff,0 0 20px #aaccff;z-index:998;pointer-events:none;animation:glow 3s ease-in-out infinite alternate}
        @keyframes glow{from{text-shadow:0 0 10px #fff,0 0 20px #aaccff;opacity:.9}to{text-shadow:0 0 20px #fff,0 0 40px #0088ff;opacity:1}}
        .btn-group{position:absolute;top:120px;right:20px;display:flex;flex-direction:column;gap:15px;z-index:999;align-items:flex-end}
        .action-btn{padding:10px 18px;border-radius:50px;font-size:14px;cursor:pointer;color:rgba(255,255,255,.95);transition:all .3s;white-space:nowrap}
        .glass-btn{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);backdrop-filter:blur(8px);box-shadow:0 4px 15px rgba(0,0,0,.2)}
        .action-btn:active{transform:scale(.95);background:rgba(255,255,255,.25)}
        #clearBtn{background:rgba(255,50,50,.2);border:1px solid rgba(255,100,100,.3)}
        .privacy-hint{font-size:10px;color:rgba(255,255,255,.6);margin-top:5px;text-align:right;font-family:sans-serif;letter-spacing:.5px}
        #tip{position:absolute;bottom:30px;width:100%;text-align:center;color:rgba(255,255,255,.6);font-size:14px;pointer-events:none;text-shadow:0 0 5px rgba(0,0,0,.8);animation:fadeTip 2s infinite ease-in-out}
        @keyframes fadeTip{0%,100%{opacity:.4}50%{opacity:1}}
    </style>
</head>
<body>
    <div id="title">Merry Christmas</div>
    <input type="file" id="fileInput" accept="image/*" multiple style="display:none">
    <div class="btn-group">
        <div id="musicBtn" class="action-btn glass-btn">Play Music</div>
        <div id="clearBtn" class="action-btn glass-btn">Clear Photos</div>
        <div id="uploadBtn" class="action-btn glass-btn" onclick="document.getElementById('fileInput').click()">Upload Photos</div>
        <div class="privacy-hint">*Privacy Safe: Photos stay on your device.</div>
    </div>
    <div id="tip">Double Tap to Explore</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        const scene=new THREE.Scene();scene.fog=new THREE.FogExp2(0x000510,0.015);
        const camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,1000);camera.position.set(0,2,14);
        const renderer=new THREE.WebGLRenderer({antialias:true,powerPreference:"high-performance"});
        renderer.setSize(innerWidth,innerHeight);renderer.setPixelRatio(Math.min(devicePixelRatio,2));
        document.body.appendChild(renderer.domElement);
        const controls=new THREE.OrbitControls(camera,renderer.domElement);
        controls.enableDamping=true;controls.autoRotate=true;controls.autoRotateSpeed=4;

        let christmasGroup=new THREE.Group();scene.add(christmasGroup);
        let isExploded=false;

        // 音乐
        const musicBtn=document.getElementById('musicBtn');let isMusicPlaying=false;
        let sound=new Audio('https://cdn.jsdelivr.net/gh/mozartalelu/merry-christmas-bg/we-wish-you-a-merry-christmas.mp3');
        sound.loop=true;sound.volume=1;
        document.body.addEventListener('touchstart',()=>sound.load(),{once:true});
        musicBtn.addEventListener('click',e=>{e.stopPropagation();
            if(isMusicPlaying){sound.pause();musicBtn.innerText="Play Music";musicBtn.style.background="rgba(255,255,255,.15)"}
            else{sound.play().then(()=>{musicBtn.innerText="Pause Music";musicBtn.style.background="rgba(50,255,50,.2)"}).catch(()=>alert("iOS限制，请再点一次"))}
            isMusicPlaying=!isMusicPlaying;
        });

        // 烟花粒子纹理
        function createFireworkTexture(){const c=document.createElement('canvas');c.width=c.height=32;const ctx=c.getContext('2d');
            const g=ctx.createRadialGradient(16,16,0,16,16,16);g.addColorStop(0,'#fff');g.addColorStop(1,'transparent');
            ctx.fillStyle=g;ctx.fillRect(0,0,32,32);return new THREE.CanvasTexture(c);}
        const fireTex=createFireworkTexture();let fireworks=[];

        class Firework{constructor(scene){this.scene=scene;this.isDead=false;this.life=1;
            const count=60;const geo=new THREE.BufferGeometry();const pos=[];const vel=[];
            const color=new THREE.Color().setHSL(Math.random(),1,.7);
            const cx=(Math.random()-.5)*20,cy=5+Math.random()*10,cz=-10;
            for(let i=0;i<count;i++){pos.push(cx,cy,cz);
                const theta=Math.random()*Math.PI*2,phi=Math.random()*Math.PI,spd=.2+Math.random()*.4;
                vel.push(Math.sin(phi)*Math.cos(theta)*spd,Math.sin(phi)*Math.sin(theta)*spd,Math.cos(phi)*spd);}
            geo.setAttribute('position',new THREE.Float32BufferAttribute(pos,3));
            this.mesh=new THREE.Points(geo,new THREE.PointsMaterial({size:1.5,color,map:fireTex,transparent:true,blending:THREE.AdditiveBlending,depthWrite:false}));
            this.vel=vel;scene.add(this.mesh);}
            update(){if(this.isDead)return;const pos=this.mesh.geometry.attributes.position.array;
                for(let i=0;i<this.vel.length/3;i++){pos[i*3]+=this.vel[i*3];pos[i*3+1]+=this.vel[i*3+1];pos[i*3+2]+=this.vel[i*3+2];
                    this.vel[i*3+1]-=.003;}this.mesh.geometry.attributes.position.needsUpdate=true;
                this.life-=.015;this.mesh.material.opacity=this.life;
                if(this.life<=0){this.isDead=true;this.scene.remove(this.mesh);this.mesh.geometry.dispose();}}}
        
        let lastTapTime=0;
        renderer.domElement.addEventListener('touchend',e=>{const now=Date.now();
            if(now-lastTapTime<300){toggleExplosion();e.preventDefault()}lastTapTime=now;});
        window.addEventListener('dblclick',e=>{if(!e.target.closest('.action-btn'))toggleExplosion();});

        function toggleExplosion(){isExploded=!isExploded;controls.autoRotate=!isExploded;
            if(isExploded)for(let i=0;i<5;i++)setTimeout(()=>fireworks.push(new Firework(scene)),i*250);}

        // 流星+银河
        function createMeteorTexture(){const c=document.createElement('canvas');c.width=32;c.height=32;const ctx=c.getContext('2d');
            const g=ctx.createLinearGradient(0,0,32,0);g.addColorStop(0,'transparent');g.addColorStop(1,'white');
            ctx.fillStyle=g;ctx.fillRect(0,0,32,32);return new THREE.CanvasTexture(c);}
        const meteorTex=createMeteorTexture();let meteors=[];
        function updateMeteors(){if(Math.random()>.94&&meteors.length<8){
            const m=new THREE.Mesh(new THREE.PlaneGeometry(2,.1),new THREE.MeshBasicMaterial({map:meteorTex,transparent:true,opacity:.8,side:THREE.DoubleSide,blending:THREE.AdditiveBlending}));
            m.position.set(20+Math.random()*20,20+Math.random()*20,-20);m.rotation.z=Math.PI/4;scene.add(m);
            meteors.push({mesh:m,speed:.4+Math.random()*.4});}
            for(let i=meteors.length-1;i>=0;i--){const it=meteors[i];
                it.mesh.position.x-=it.speed;it.mesh.position.y-=it.speed*.7;
                if(it.mesh.position.x<-30){scene.remove(it.mesh);meteors.splice(i,1);}}}
        
        function createGalaxyStars(){const geo=new THREE.BufferGeometry();const pos=[];const colors=[];const col=new THREE.Color();
            for(let i=0;i<6000;i++){pos.push((Math.random()-.5)*350,(Math.random()-.5)*350,(Math.random()-.5)*350);
                const r=Math.random();col.setHex(r>.9?0xaaccff:r>.8?0xffddaa:0xffffff);
                colors.push(col.r,col.g,col.b);}
            geo.setAttribute('position',new THREE.Float32BufferAttribute(pos,3));
            geo.setAttribute('color',new THREE.Float32BufferAttribute(colors,3));
            scene.add(new THREE.Points(geo,new THREE.PointsMaterial({size:.25,vertexColors:true,transparent:true,opacity:.9,sizeAttenuation:true})));}
        createGalaxyStars();

        // 冰雪圣诞树（纯白/银/冰蓝）
        function getTreePosition(h=12,r=6){const y=Math.random()*h-h/2;const norm=(y+h/2)/h;
            const rad=r*(1-norm)*Math.sqrt(Math.random());const ang=Math.random()*Math.PI*2;
            return {x:Math.cos(ang)*rad,y,z:Math.sin(ang)*rad};}
        function createLeaves(){const geo=new THREE.BufferGeometry();const pos=[];const col=[];const c=new THREE.Color();
            for(let i=0;i<1800;i++){const p=getTreePosition(13,6.5);pos.push(p.x,p.y,p.z);
                const r=Math.random();c.setHex(r>.7?0xffffff:r>.4?0xddeeff:0xaaccff);col.push(c.r,c.g,c.b);}
            geo.setAttribute('position',new THREE.Float32BufferAttribute(pos,3));
            geo.setAttribute('color',new THREE.Float32BufferAttribute(col,3));
            christmasGroup.add(new THREE.Points(geo,new THREE.PointsMaterial({size:.5,vertexColors:true,transparent:true,opacity:.9,blending:THREE.AdditiveBlending})));}
        createLeaves();

        // 树顶星+灯光
        function createTopStar(){const shape=new THREE.Shape();const pts=5,outer=.8,inner=.4;
            for(let i=0;i<pts*2;i++){const a=i*Math.PI/pts;const r=i%2===0?outer:inner;
                if(i===0)shape.moveTo(Math.cos(a)*r,Math.sin(a)*r);else shape.lineTo(Math.cos(a)*r,Math.sin(a)*r);}
            shape.closePath();const geo=new THREE.ExtrudeGeometry(shape,{depth:.3,bevelEnabled:true});
            const mat=new THREE.MeshStandardMaterial({color:0xffffff,emissive:0xffffff,emissiveIntensity:.8,roughness:.1,metalness:.9});
            const star=new THREE.Mesh(geo,mat);star.position.y=6.5;christmasGroup.add(star);
            scene.add(new THREE.PointLight(0xffffff,1,10).translateY(6.5));}
        createTopStar();

        function addDecorLights(){const geo=new THREE.BufferGeometry();const pos=[];const col=[];const c=new THREE.Color();
            const colors=[0x00ffff,0xffffff,0xaaaaff,0xffd700];
            for(let i=0;i<500;i++){const p=getTreePosition(12.5,6.2);pos.push(p.x*1.05,p.y,p.z*1.05);
                c.setHex(colors[~~(Math.random()*colors.length)]);col.push(c.r,c.g,c.b);}
            geo.setAttribute('position',new THREE.Float32BufferAttribute(pos,3));
            geo.setAttribute('color',new THREE.Float32BufferAttribute(col,3));
            christmasGroup.add(new THREE.Points(geo,new THREE.PointsMaterial({size:.8,map:fireTex,vertexColors:true,transparent:true,blending:THREE.AdditiveBlending,depthWrite:false})));}
        addDecorLights();

        // 照片功能（宝丽来+光晕）
        function createGlowTexture(){const c=document.createElement('canvas');c.width=c.height=64;const ctx=c.getContext('2d');
            const g=ctx.createRadialGradient(32,32,0,32,32,32);g.addColorStop(0,'rgba(200,220,255,.4)');g.addColorStop(1,'transparent');
            ctx.fillStyle=g;ctx.fillRect(0,0,64,64);return new THREE.CanvasTexture(c);}
        const glowTex=createGlowTexture();
        const glowMat=new THREE.SpriteMaterial({map:glowTex,transparent:true,blending:THREE.AdditiveBlending,depthWrite:false});

        function createPolaroidTexture(img){const c=document.createElement('canvas');c.width=256;c.height=300;const ctx=c.getContext('2d');
            ctx.fillStyle='#f0f8ff';ctx.fillRect(0,0,256,300);const b=15,s=256-b*2;
            const sc=Math.max(s/img.width,s/img.height);const px=(s/2)-(img.width/2)*sc,py=(s/2)-(img.height/2)*sc;
            ctx.save();ctx.beginPath();ctx.rect(b,b,s,s);ctx.clip();
            ctx.drawImage(img,b+px,b+py,img.width*sc,img.height*sc);ctx.restore();
            ctx.strokeStyle='#ccc';ctx.lineWidth=2;ctx.strokeRect(0,0,256,300);
            return new THREE.CanvasTexture(c);}
        const cardGeo=new THREE.PlaneGeometry(1.2,1.4);

        document.getElementById('fileInput').addEventListener('change',e=>{const files=Array.from(e.target.files).slice(0,25);
            files.forEach(file=>{const reader=new FileReader();reader.onload=ev=>{const img=new Image();img.src=ev.target.result;img.onload=()=>{
                const tex=createPolaroidTexture(img);
                const mat=new THREE.MeshStandardMaterial({map:tex,side:THREE.DoubleSide,roughness:.8,metalness:.1,emissive:0xffffff,emissiveIntensity:.1});
                const card=new THREE.Mesh(cardGeo,mat);
                const p=getTreePosition(12,6);card.position.set(p.x*1.3,p.y,p.z*1.3);
                card.lookAt(0,p.y,0);card.rotation.z+=(Math.random()-.5)*.3;card.rotation.x+=.1;
                const glow=new THREE.Sprite(glowMat);glow.scale.set(3,3,1);glow.position.z=-.1;card.add(glow);
                const tx=(Math.random()-.5)*14,ty=(Math.random()-.5)*12,tz=5+Math.random()*4;
                card.userData={type:'photo',originPos:card.position.clone(),originRot:card.rotation.clone(),
                    targetPos:new THREE.Vector3(tx,ty,tz),randomPhase:Math.random()*Math.PI*2};
                christmasGroup.add(card);}};reader.readAsDataURL(file);});});

        document.getElementById('clearBtn').addEventListener('click',e=>{e.stopPropagation();
            for(let i=christmasGroup.children.length-1;i>=0;i--)if(christmasGroup.children[i].userData.type==='photo')christmasGroup.remove(christmasGroup.children[i]);});

        scene.add(new THREE.AmbientLight(0xffffff,.6));
        scene.add(new THREE.DirectionalLight(0xffffff,1));

        function animate(){requestAnimationFrame(animate);controls.update();updateMeteors();
            fireworks.forEach((f,i)=>{f.update();if(f.isDead)fireworks.splice(i,1);});
            const time=Date.now()*.001;const lerpSpeed=.05;
            if(isExploded)christmasGroup.rotation.y+=.001;
            const bgStars=scene.children.find(c=>c.userData?.type==='bgStars');
            if(bgStars){bgStars.rotation.y-=.0003;bgStars.material.opacity=.85+Math.sin(time*1.5)*.15);
            christmasGroup.children.forEach(o=>{if(o.userData.type==='photo'){
                if(isExploded){o.position.lerp(o.userData.targetPos,lerpSpeed);o.scale.lerp(new THREE.Vector3(1.8,1.8,1.8),lerpSpeed);
                    o.position.y+=Math.sin(time+o.userData.randomPhase)*.005;o.lookAt(camera.position);
                    if(o.children[0])o.children[0].scale.lerp(new THREE.Vector3(4,4,1),lerpSpeed);}
                else{o.position.lerp(o.userData.originPos,lerpSpeed);o.scale.lerp(new THREE.Vector3(1,1,1),lerpSpeed);
                    if(o.position.distanceTo(o.userData.originPos)<1)o.rotation.lerp(o.userData.originRot,.1);
                    else o.lookAt(0,o.position.y,0);
                    if(o.children[0])o.children[0].scale.lerp(new THREE.Vector3(3,3,1),lerpSpeed);}}
                if(o.userData.type==='leaves'){o.scale.lerp(new THREE.Vector3(isExploded?3.5:1,isExploded?3.5:1,isExploded?3.5:1),lerpSpeed);
                    o.material.opacity=THREE.MathUtils.lerp(o.material.opacity,isExploded?.1:.9,lerpSpeed);o.rotation.y=isExploded?.002:0;}
                if(o.userData.type==='lights'){o.scale.lerp(new THREE.Vector3(isExploded?2:1,isExploded?2:1,isExploded?2:1),lerpSpeed);
                    o.material.opacity=THREE.MathUtils.lerp(o.material.opacity,isExploded?1:.8,lerpSpeed);}
                if(o.userData.type==='star')o.scale.lerp(new THREE.Vector3(isExploded?.001:1,isExploded?.001:1,isExploded?.001:1),lerpSpeed);
                if(o.userData.type==='star')o.rotation.y+=.01;});
            renderer.render(scene,camera);}
        animate();

        window.addEventListener('resize',()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight);});
    </script>
</body>
</html>